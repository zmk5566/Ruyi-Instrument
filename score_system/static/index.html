<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- load style.css -->
    <link rel="stylesheet" href="css/style.css">
    <title>ABC Notation to SVG</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="dist/abcjs-basic.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/Tone.js"></script>
    <script src="bar_helper.js"></script>
    <script>

    // trigger the drawSVG(1) function when the page loads

    window.onload = function() {

    // add a listener to the choices select element
    document.getElementById('choices').addEventListener('change', function(){
        // get the value of the selected option
        var selection_name = this.value;
        // trigger the triggerSelection function
        triggerSelection(selection_name);
    });



        //drawSVG();
        load_all_configs();
    };
     

    </script>
</head>
<body>



<div id="score">
<h3 id="title">-</h3>
<div id="svgContainer">
<div id="meta_data">
<div id="left-score">1=<a id="key"> </a>, <a id="num"></a>/ <a id="den"></a>

    <div>BPM:  <a id=bpm>-</a></div>


</div>
<div id="right-score">

<div id="composer"></div>
</div>
    


</div>
<div id="svgSpecific">

</div>
</div>
</div>


<div id="control_pannel">
    <div id="choose_score">
     <select id="choices">
     </select>
     <select id="choice-parts">
    </select>
    </div>

    <!-- Button container to group buttons in one line -->
    <div class="button-container">
        <button onclick="drawSVG()">重绘</button>
        <button id="startButton">开始</button>
        <button id="stopButton">停止</button>
        <button id="sendWebStartButton">START</button>
        <button id="sendWebStopButton">STOP</button>
    </div>
    
    <div id="timePassed">Time Passed: 0 seconds</div>
</div>


<script>





function load_all_configs(){
    // Load all
    // peform an AJAX call to load all possibile configurations
    // it looks something like {"scrolls":[{"name":"茉莉花","abc_scrolls":["1.abc","2.abc","3.abc"]},{"name":"月光下的凤尾竹","abc_scrolls":["1.abc","2.abc"]}]}
    // when it sucess, trigger the generate inferface function
    // when it fails, show an error message
    $.ajax({
        url: '/scroll',
        type: 'GET',
        success: function(response){
            console.log(response);
            generate_interface(response);
        },
        error: function(error){
            console.log(error);
        }
    });
    
    

}

// a json would look like this: {"scrolls":[{"name":"茉莉花","abc_scrolls":["1.abc","2.abc","3.abc"]},{"name":"月光下的凤尾竹","abc_scrolls":["1.abc","2.abc"]}]}
function generate_interface(input_json){
    // clear the previous interface
    document.getElementById('choices').innerHTML = "";
    // add a dummy option with no value
    var option = document.createElement('option');
    option.value = "";
    option.innerHTML = "--请选择--";
    document.getElementById('choices').appendChild(option);

    document.getElementById('choice-parts').innerHTML = "";
    // iterate through the key scrolls
    // for each key scroll, create a new div
    // add the name of the scroll to the div
    input_json.scrolls.forEach(element => {
        // create a new option element
        var option = document.createElement('option');
        option.value = element.name;
        option.innerHTML = element.name;
        document.getElementById('choices').appendChild(option);
        // now do a ajax call to get the parts
        console.log(element);
        
    });
}

function triggerSelection(selection_name){
    $.ajax({
            url: '/scroll/' + selection_name,
            type: 'GET',
            success: function(response){
                // clear the previous interface
                document.getElementById('choice-parts').innerHTML = "";
                console.log(response);
                // iterate through the parts
                response.parts.forEach(part => {
                    // create a new option element
                    var option = document.createElement('option');
                    option.value = part;
                    option.innerHTML = part;
                    document.getElementById('choice-parts').appendChild(option);
                });
            },
            error: function(error){
                console.log(error);
            }
        });
    
}



function drawSVG() {

    const choice = document.getElementById('choices').value;

    var abcNotation = "";
    // Display the corresponding string
    if (choice === "1") {
        abcNotation = abc;
    } else if (choice === "2") {
        abcNotation = abc;
    }




    //const svgOutput = parse_notes(abcNotation); // Assuming no shift is needed for this example
    const svgOutput = draw_score(abcNotation,20,40);
    var meta_data  = getGeneralInfo(abcNotation);
    document.getElementById('title').innerHTML = meta_data.title;
    document.getElementById('key').innerHTML = meta_data.key;
    document.getElementById('bpm').innerHTML = meta_data.bpm;
    document.getElementById('num').innerHTML = meta_data.time_signature.num;
    document.getElementById('den').innerHTML = meta_data.time_signature.den;
    document.getElementById('composer').innerHTML = meta_data.composer;

    console.log(getGeneralInfo(abcNotation));
    //console.log(svgOutput);
    document.getElementById('svgSpecific').innerHTML = svgOutput;
}
</script>

</body>
</html>
